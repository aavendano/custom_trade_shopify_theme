{% capture imagekit %}
  {% if settings.enableimagekit %}
    {% for i in (1..1) %}
      {% unless src or settings.imagekiturl != blank %}
        {{ src }}
        {% break %}
      {% endunless %}
      {% assign cdnurls = settings.imagekitshopifycdnurl | split: ',' %}
    {% if cdnurls.size  == 0 %}
    {{ src }}
        {% break %}
    {% endif %}
      {% assign cdnurl = cdnurls[0] %}
      {% for temp in cdnurls %}
        {% if src contains temp %}
          {% assign cdnurl = temp %}
          {% break %}
        {% endif %}
      {% endfor %}
    {% assign cdnurl = cdnurl | strip %}
    {% unless src contains cdnurl %}
        {{ src }}
        {% break %}
      {% endunless %}
    {% assign imagekiturl = settings.imagekiturl | strip %}
      {% assign tempimagekiturl = imagekiturl %}
      {% assign lastchar = imagekiturl | slice:-1 %}
      {% assign imagekiturllength = imagekiturl | size %}
      {% assign newimagekiturl = imagekiturllength | minus:1 %}
      {% if lastchar == "/" %}
        {% assign tempimagekiturl = imagekiturl | slice:0,newimagekiturl %}
      {% endif %}
    {% assign newsrc = src | strip | replace:cdnurl,tempimagekiturl %}
    {{ newsrc | default:src }}
    {% endfor %}
  {% else %}
    {{ src }}
  {% endif %}
{% endcapture %}{{ imagekit | strip | replace:'  ' | strip_newlines }}